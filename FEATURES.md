# 🚀 飞书机器人功能清单

## ✨ 核心功能

### 1. 多消息类型支持

机器人现在可以识别并响应以下消息类型：

- ✅ **文本消息** - 完全支持，调用AI智能回复
- 📷 **图片消息** - 识别并友好提示（暂不支持分析）
- 📄 **文件消息** - 识别并友好提示（暂不支持分析）
- 🎤 **音频消息** - 识别并友好提示（暂不支持语音识别）
- ⚠️ **其他类型** - 友好提示仅支持文本

### 2. 对话历史记录

- 📝 自动保存每个用户的对话历史（最近10条）
- 🔄 AI回复时会参考历史上下文
- 💾 历史存储在内存中（重启后清空）
- 📊 可通过API查询和清空历史

### 3. 用户权限控制

- 🔐 支持用户白名单机制
- 🚫 未授权用户会收到友好提示
- ⚙️ 通过环境变量 `ALLOWED_USERS` 配置
- 📋 默认允许所有用户（白名单为空时）

## 🛠️ API接口

### 基础接口

#### 1. 健康检查
```bash
GET /health
```
返回服务状态

#### 2. 统计信息
```bash
GET /stats
```
返回：
- 总用户数
- 总消息数
- 活跃用户列表
- Qoder配置信息
- 权限状态

### 对话历史管理

#### 3. 查看用户历史
```bash
GET /history/<user_id>?limit=10
```
查看指定用户的对话历史

#### 4. 清空用户历史
```bash
DELETE /history/<user_id>
```
清空指定用户的对话历史

### 测试接口

#### 5. 发送测试消息
```bash
POST /test/send
{
  "chat_id": "oc_xxx",
  "message": "测试消息"
}
```

## 📖 使用示例

### 在飞书中测试不同消息类型

1. **发送文本** - 获得AI智能回复
2. **发送图片** - 收到"暂不支持图片分析"提示
3. **发送文件** - 收到"暂不支持文件分析"提示

### 查看统计信息
```bash
curl http://localhost:5004/stats
```

### 查看用户对话历史
```bash
curl http://localhost:5004/history/USER_ID?limit=5
```

### 清空用户历史
```bash
curl -X DELETE http://localhost:5004/history/USER_ID
```

## ⚙️ 配置说明

### 启用用户权限控制

在 `.env` 文件中添加：
```
ALLOWED_USERS=user_id_1,user_id_2,user_id_3
```

### 调整历史记录数量

修改 `feishu_bot.py` 中的常量：
```python
MAX_HISTORY_LENGTH = 10  # 改为你需要的数量
```

## 🔄 工作流程

```
用户发送消息
    ↓
检查用户权限
    ↓
识别消息类型
    ↓
保存到对话历史
    ↓
调用AI（携带历史上下文）
    ↓
保存AI回复到历史
    ↓
发送回复到飞书
```

## 📊 数据结构

### 对话历史格式
```json
{
  "role": "user",  // 或 "assistant"
  "content": "消息内容",
  "timestamp": "2026-01-27T09:00:00"
}
```

## 🎯 后续可扩展功能

1. **持久化存储** - 将对话历史保存到数据库
2. **图片分析** - 集成图像识别API
3. **文件解析** - 支持PDF、Word等文件分析
4. **语音识别** - 支持语音转文字
5. **多轮对话** - 更智能的上下文理解
6. **用户画像** - 记录用户偏好

## 🎉 已实现功能总结

✅ 多消息类型识别  
✅ 对话历史记录（内存）  
✅ 用户权限控制  
✅ 完整的API接口  
✅ 统计信息查询  
✅ AI智能回复（集成Qoder）  
✅ 错误友好提示  
✅ 日志记录完整  

---

**当前版本**: v2.0 Enhanced  
**最后更新**: 2026-01-27
